-- === Normalize content into the keys your page reads ===
-- (Safe to run multiple times)

WITH data AS (

  -- About
  SELECT 'about' AS key, (SELECT value FROM phoenix_content WHERE key='about') AS value

  UNION ALL
  -- Draught beer list (prefer 'beerlist', else copy from 'beer.list')
  SELECT 'beerlist',
         COALESCE(
           (SELECT value FROM phoenix_content WHERE key='beerlist'),
           (SELECT value FROM phoenix_content WHERE key='beer.list')
         )

  UNION ALL
  -- Deals (prefer new keys; fallback to old ones)
  SELECT 'deal1', COALESCE(
           (SELECT value FROM phoenix_content WHERE key='deal1'),
           (SELECT value FROM phoenix_content WHERE key='deals.0')
         )
  UNION ALL
  SELECT 'deal2', (SELECT value FROM phoenix_content WHERE key='deal2')
  UNION ALL
  SELECT 'deal3', COALESCE(
           (SELECT value FROM phoenix_content WHERE key='deal3'),
           (SELECT value FROM phoenix_content WHERE key='deals.2')
         )
  UNION ALL
  SELECT 'deal4', COALESCE(
           (SELECT value FROM phoenix_content WHERE key='deal4'),
           (SELECT value FROM phoenix_content WHERE key='deals.3')
         )

  UNION ALL
  -- What's On (copy whatson.* -> weekday keys)
  SELECT 'monday',    COALESCE((SELECT value FROM phoenix_content WHERE key='monday'),    (SELECT value FROM phoenix_content WHERE key='whatson.mon'))
  UNION ALL
  SELECT 'tuesday',   COALESCE((SELECT value FROM phoenix_content WHERE key='tuesday'),   (SELECT value FROM phoenix_content WHERE key='whatson.tue'))
  UNION ALL
  SELECT 'wednesday', COALESCE((SELECT value FROM phoenix_content WHERE key='wednesday'), (SELECT value FROM phoenix_content WHERE key='whatson.wed'))
  UNION ALL
  SELECT 'thursday',  COALESCE((SELECT value FROM phoenix_content WHERE key='thursday'),  (SELECT value FROM phoenix_content WHERE key='whatson.thu'))
  UNION ALL
  SELECT 'friday',    COALESCE((SELECT value FROM phoenix_content WHERE key='friday'),    (SELECT value FROM phoenix_content WHERE key='whatson.fri'))
  UNION ALL
  SELECT 'saturday',  COALESCE((SELECT value FROM phoenix_content WHERE key='saturday'),  (SELECT value FROM phoenix_content WHERE key='whatson.sat'))
  UNION ALL
  SELECT 'sunday',    COALESCE((SELECT value FROM phoenix_content WHERE key='sunday'),    (SELECT value FROM phoenix_content WHERE key='whatson.sun'))

  UNION ALL
  -- Fixtures: build match1..3 from fx.* parts if matchN not already set
  SELECT 'match1',
         COALESCE(
           (SELECT value FROM phoenix_content WHERE key='match1'),
           (
             SELECT
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.0.home'),'Home')
               || ' vs ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.0.away'),'Away')
               || ' — ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.0.day'),'Day')
               || ' ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.0.date'),'Date')
               || ' — ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.0.time'),'KO')
               || ' — ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.0.channel'),'Channel')
           )
         )
  UNION ALL
  SELECT 'match2',
         COALESCE(
           (SELECT value FROM phoenix_content WHERE key='match2'),
           (
             SELECT
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.1.home'),'Home')
               || ' vs ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.1.away'),'Away')
               || ' — ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.1.day'),'Day')
               || ' ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.1.date'),'Date')
               || ' — ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.1.time'),'KO')
               || ' — ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.1.channel'),'Channel')
           )
         )
  UNION ALL
  SELECT 'match3',
         COALESCE(
           (SELECT value FROM phoenix_content WHERE key='match3'),
           (
             SELECT
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.2.home'),'Home')
               || ' vs ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.2.away'),'Away')
               || ' — ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.2.day'),'Day')
               || ' ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.2.date'),'Date')
               || ' — ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.2.time'),'KO')
               || ' — ' ||
               COALESCE((SELECT value FROM phoenix_content WHERE key='fx.2.channel'),'Channel')
           )
         )

  UNION ALL
  -- Hours: keep your formatted list; if missing, build from hours.mon..sun
  SELECT 'hours',
         COALESCE(
           (SELECT value FROM phoenix_content WHERE key='hours'),
           (
             SELECT
               '<li>Monday: '    || COALESCE((SELECT value FROM phoenix_content WHERE key='hours.mon'),'') || '</li>' ||
               '<li>Tuesday: '   || COALESCE((SELECT value FROM phoenix_content WHERE key='hours.tue'),'') || '</li>' ||
               '<li>Wednesday: ' || COALESCE((SELECT value FROM phoenix_content WHERE key='hours.wed'),'') || '</li>' ||
               '<li>Thursday: '  || COALESCE((SELECT value FROM phoenix_content WHERE key='hours.thu'),'') || '</li>' ||
               '<li>Friday: '    || COALESCE((SELECT value FROM phoenix_content WHERE key='hours.fri'),'') || '</li>' ||
               '<li>Saturday: '  || COALESCE((SELECT value FROM phoenix_content WHERE key='hours.sat'),'') || '</li>' ||
               '<li>Sunday: '    || COALESCE((SELECT value FROM phoenix_content WHERE key='hours.sun'),'') || '</li>'
           )
         )

  UNION ALL
  -- Posters (already correct naming)
  SELECT 'live.0.poster', (SELECT value FROM phoenix_content WHERE key='live.0.poster')
  UNION ALL SELECT 'live.1.poster', (SELECT value FROM phoenix_content WHERE key='live.1.poster')
  UNION ALL SELECT 'live.2.poster', (SELECT value FROM phoenix_content WHERE key='live.2.poster')
  UNION ALL SELECT 'live.3.poster', (SELECT value FROM phoenix_content WHERE key='live.3.poster')

  UNION ALL
  -- Gallery / Videos lists
  SELECT 'gallery.list', (SELECT value FROM phoenix_content WHERE key='gallery.list')
  UNION ALL
  SELECT 'videos.list',  (SELECT value FROM phoenix_content WHERE key='videos.list')

  UNION ALL
  -- Contact
  SELECT 'contact', (SELECT value FROM phoenix_content WHERE key='contact')
)

INSERT INTO phoenix_content (key, value)
SELECT key, value FROM data WHERE value IS NOT NULL
ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value;
